<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Segoe UI', Arial, sans-serif; }
    .container { display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 240px; background-color: #fdfffa; padding: 20px 0; display: flex; flex-direction: column; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 1.5rem; margin-bottom: 30px; padding-left: 20px;
      background: linear-gradient(70deg, #cc79f0, #3e7ef7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .logo img { height: 40px; width: auto; object-fit: contain; margin-left: 5px; }
    .nav { display: flex; flex-direction: column; flex: 1; overflow-y: auto; }
    .nav a, .bottom a { font-size: 14px; display: flex; align-items: center; gap: 12px; padding: 11px 20px; color: #333135; font-weight: 640; text-decoration: none; border-radius: 8px; margin: 0 7px; transition: background-color 0.3s, color 0.3s; }
    .nav a:hover, .bottom a:hover { background: linear-gradient(90deg, #cc79f0, #3e7ef7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav a.active { background: linear-gradient(90deg, #cc79f0, #3e7ef7); color: #fdfffa; }
    .bottom { margin-top: auto; display: flex; flex-direction: column; }
    .main { flex: 1; padding: 2rem 3rem; overflow-y: auto; font-family: 'Quicksand', sans-serif; }
    h1 { font-family: 'Poppins', sans-serif; font-size: 26px; margin-bottom: 2rem; color: #333135; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card h3 { font-size: 14px; color: #4B5563; margin-bottom: 8px; }
    .card .value { font-size: 22px; font-weight: 700; font-family: 'Poppins', sans-serif; }
    .section-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; text-align: left; }
    th { color: #4B5563; font-weight: 600; border-bottom: 1px solid #eee; }
    tr:nth-child(even) { background: #f9f9f9; }
    canvas { background: #fff; border-radius: 12px; padding: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="logo"><img src="logo.png" alt="Logo" />SkinBloom</div>
        <nav class="nav">
          <a href="dashboard.html" class="active">Dashboard</a>
          <a href="customers_data.html">Customers Data</a>
          <a href="leads.html">Lead & Opportunity</a>
          <a href="sales_order.html">Sales Order</a>
          <a href="quota.html">Quotations & Pricing</a>
          <a href="cs_tickets.html">Customer Support</a>
        </nav>
      </div>
      <div class="bottom">
        <a href="#">Reports</a>
        <a href="#">Settings</a>
        <a href="#">Logout</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <h1>Welcome to SkinBloom — CRM!</h1>

      <!-- Summary Cards -->
      <div class="dashboard-grid">
        <div class="card"><h3>Total Customers</h3><div class="value" id="totalCustomers"></div></div>
        <div class="card"><h3>Active Orders</h3><div class="value" id="activeOrders"></div></div>
        <div class="card"><h3>Open Opportunities</h3><div class="value" id="openOpportunities"></div></div>
        <div class="card"><h3>Total Revenue</h3><div class="value" id="totalRevenue"></div></div>
      </div>

      <!-- Sales Trend -->
      <div class="card" style="margin-top:20px;">
        <h3>Monthly Sales Trend</h3>
        <canvas id="salesTrendChart"></canvas>
      </div>

      <!-- Leads & Customers -->
      <div class="section-grid">
        <div class="card">
          <h3>New Leads This Week</h3>
          <table id="leadsTable">
            <thead><tr><th>Name</th><th>Interest</th><th>Source</th><th>Assigned To</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Top Customers</h3>
          <table id="topCustomersTable">
            <thead><tr><th>Name</th><th>Total Orders</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Opportunities -->
      <div class="card" style="margin-top:20px;">
        <h3>Leads and Opportunity</h3>
        <table id="opportunityTable">
          <thead><tr><th>Stage</th><th>Count</th><th>Value</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

    <script>
      async function loadDashboard() {
        try {
          const res = await fetch('/api/dashboard-data');
          const data = await res.json();

          // Summary cards
          document.getElementById('totalCustomers').textContent = data.summary.totalCustomers;
          document.getElementById('activeOrders').textContent = data.summary.activeOrders;
          document.getElementById('openOpportunities').textContent = data.summary.openOpportunities;
          document.getElementById('totalRevenue').textContent = `₱${Number(data.summary.totalRevenue).toLocaleString()}`;

          // Sales Trend Chart
          const salesCtx = document.getElementById('salesTrendChart');
          salesCtx._chart = new Chart(salesCtx, {
            type: 'line',
            data: {
              labels: data.salesTrend.map(s => s.month),
              datasets: [{
                label: 'Sales',
                data: data.salesTrend.map(s => s.amount),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true,
                tension: 0.3
              }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
          });

          // New leads
          document.querySelector('#leadsTable tbody').innerHTML =
            data.newLeads.map(l => `
            <tr>
              <td>${l.name}</td>
              <td>${l.interest}</td>
              <td>${l.source}</td>
              <td>${l.assigned_to}</td>
            </tr>`).join('');

          // Top customers
          document.querySelector('#topCustomersTable tbody').innerHTML =
            data.topCustomers.map(c => `<tr><td>${c.category}</td><td>${c.total_orders}</td></tr>`).join('');

          // Opportunities
          document.querySelector('#opportunityTable tbody').innerHTML =
            data.opportunities.map(o => `<tr><td>${o.stage}</td><td>${o.count}</td><td>₱${Number(o.total_value).toLocaleString()}</td></tr>`).join('');
        } catch (err) {
          console.error('Error loading dashboard:', err);
        }
      }

      document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>